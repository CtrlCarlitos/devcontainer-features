# Dev Container Features

This repository provides a small set of Dev Container Features for AI tooling and developer ergonomics.

## Features

| Feature | Description | Min Node.js |
|---------|-------------|-------------|
| `node` | Installs Node.js via nvm | - |
| `claude-code` | Anthropic's Claude Code CLI | 18+ |
| `opencode` | OpenCode AI terminal agent | 18+ |
| `gemini-cli` | Google's Gemini CLI | 20+ |
| `bmad-method` | BMad Agile AI framework | 20+ |
| `codex` | OpenAI's Codex CLI | 22+ |
| `nerd-font` | Nerd Fonts (Meslo, etc.) | - |

## Node.js Version Requirements

The `node` feature defaults to **v22**, which satisfies all feature requirements:

```
node (default: 22)
    ├── codex (requires 22+) ✅
    ├── bmad-method (requires 20+) ✅
    ├── gemini-cli (requires 20+) ✅
    ├── claude-code (requires 18+) ✅
    └── opencode (requires 18+) ✅
```

Each feature validates its minimum Node.js version and fails with a helpful error if not met.

## Usage

### From GitHub Container Registry (recommended)

```json
{
  "features": {
    "ghcr.io/ctrlcarlitos/devcontainer-features/node:1": { "version": "22" },
    "ghcr.io/ctrlcarlitos/devcontainer-features/claude-code:1": {},
    "ghcr.io/ctrlcarlitos/devcontainer-features/codex:1": {},
    "ghcr.io/ctrlcarlitos/devcontainer-features/nerd-font:1": { "fonts": "Meslo,FiraCode" }
  }
}
```

### Local Development

```json
{
  "features": {
    "./src/node": { "version": "22" },
    "./src/claude-code": { "version": "latest" }
  }
}
```

## Testing

Run scenario tests with Dev Containers CLI:

```bash
npm install -g @devcontainers/cli
devcontainer features test --skip-autogenerated --project-folder .
```

## CI/CD

| Workflow | Trigger | Description |
|----------|---------|-------------|
| `Release` | Test Success | **Release Train**: Generates date-based tags (e.g. `v2026.2.1`) |
| `Publish` | Tags `v*` | Publishes features to GHCR |
| `Auto-Update` | Daily 7AM UTC | Checks for upstream updates and bumps feature versions (e.g. `1.3.0` -> `1.3.1`) |
| `Test` | Push to main, PRs | Runs feature scenario tests |

### Release Strategy

This repository uses a **Release Train** model to decouple feature updates from release tags:

1.  **Feature Versioning**: Each feature (e.g., `nerd-font`) uses semantic versioning in its `devcontainer-feature.json`.
2.  **Auto-Update**: When a tool update is detected, the feature's *patch version* is automatically incremented (e.g., `1.3.0` -> `1.3.1`).
3.  **Release Tags**: Pushes to `main` trigger the **Release Train**, which applies a date-based tag (e.g., `v2024.2.1`).
4.  **Publishing**: The tag triggers the release of any features that have changed since the last release.

## Docker Volume Mounts for AI Tools

All AI tools (Claude Code, Codex, Gemini CLI, OpenCode) store authentication, configuration, and data that should persist across container rebuilds. See [DOCKER_VOLUMES.md](DOCKER_VOLUMES.md) for detailed volume mount configurations.

### Quick Reference

| Tool | Config Path | Data Path | Cache Path | # Volumes |
|-------|-------------|------------|--------------|--------------|
| OpenCode | `~/.config/opencode` | `~/.local/share/opencode` | `~/.cache/opencode` | 3 |
| Claude Code | `~/.claude/` | N/A | N/A | 1 |
| Codex | `~/.codex/` | `~/.local/share/codex/` | `~/.cache/codex/` | 3 |
| Gemini CLI | `~/.gemini/` | `~/.local/share/gemini-cli/` | `~/.cache/gemini-cli/` | 3 |

### Complete docker-compose.yml Example

Example with all AI tools configured:

```yaml
version: '3.8'
services:
  app:
    image: mcr.microsoft.com/devcontainers/base:ubuntu
    volumes:
      # Claude Code
      - claude_config:/home/vscode/.claude

      # Codex
      - codex_config:/home/vscode/.codex
      - codex_data:/home/vscode/.local/share/codex
      - codex_cache:/home/vscode/.cache/codex

      # Gemini CLI
      - gemini_config:/home/vscode/.gemini
      - gemini_data:/home/vscode/.local/share/gemini-cli
      - gemini_cache:/home/vscode/.cache/gemini-cli

      # OpenCode
      - opencode_config:/home/vscode/.config/opencode
      - opencode_data:/home/vscode/.local/share/opencode
      - opencode_cache:/home/vscode/.cache/opencode

      # Your workspace
      - .:/workspace

volumes:
  claude_config:
  codex_config:
  codex_data:
  codex_cache:
  gemini_config:
  gemini_data:
  gemini_cache:
  opencode_config:
  opencode_data:
  opencode_cache:
```

> **Note:** Replace `/home/vscode` with `/home/node` or `/root` if using a different user.

## Security

### TLS Certificate Pinning

Installers download binaries and packages from external URLs (e.g., `https://opencode.ai/install`, `https://claude.ai/install.sh`, `https://registry.npmjs.org/`). While HTTPS is used for all downloads, TLS certificate pinning is not implemented due to complexity and maintenance overhead.

**Mitigation:**
- Optional SHA256 hash verification is available for all downloads (configure via `*_SHA256` options)
- For npm packages, `npm install` includes integrity verification
- For production deployments, verify hashes before container builds

### Supply Chain Security

- GitHub Actions use version tags (e.g., `@v4`) rather than commit SHAs for easier maintenance
- npm packages use `--ignore-scripts` to prevent postinstall script execution
- All inputs are sanitized where possible (e.g., version parameters)

For detailed security audits, see the [security-review](docs/security-review/) directory.

## License

MIT
